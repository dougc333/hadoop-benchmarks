# update the /etc/motd message
import os
import sys
import re
import subprocess
import datetime
try:
    subprocess.call(["sudo", "-n", "/var/lib/jenkins/bin/jenk-root", "chmod",  "777",  "/etc/motd"])
except:
    pass
try:
    with open("/etc/motd", "r") as motd:
        original_motd = motd.read().strip()
    m = re.search(r"(.*)\n\*\*\*RESERVATION NOTICE", original_motd, re.MULTILINE)
    if m:
        original_motd = m.group(1)
    with open("/etc/motd", "w") as motd:
        now = datetime.datetime.now()
        starttime = now.strftime("%H:%M:%S %m-%d-%Y")
        if os.environ['expiration'] != "none":
            expires = now + datetime.timedelta(hours=int(os.environ['expiration'])) 
            expiretime = "{} ({} hr)".format(expires.strftime("%H:%M:%S %m-%d-%Y"), os.environ['expiration'])
        else:
            expiretime = "never"
    
        motd.write("{}\n***RESERVATION NOTICE: Reserved by {} on {} Expires {}\n".format(original_motd,
                                                                                                                               os.environ["BUILD_USER_FIRST_NAME"],
                                                                                                                               starttime,
                                                                                                                               expiretime))
except:
    pass

    rm -f /tmp/mypipe
mkfifo /tmp/mypipe

while read SIGNAL; do
    case "$SIGNAL" in
        *EXIT*)break;;
        *)echo "signal  $SIGNAL  is unsupported" >/dev/stderr;;
    esac
done < /tmp/mypipe